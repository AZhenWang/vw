
#第一步：新增字段

alter table adj_factor add column `code_id` int  null;
alter table adj_factor add column `date_id` int  null;

alter table daily add column `code_id` int  null;
alter table daily add column `date_id` int  null;

alter table daily_basic add column `code_id` int  null;
alter table daily_basic add column `date_id` int  null;

#第二步：更新表记录

update adj_factor af inner join stock_basic sb on sb.ts_code = af.ts_code set af.code_id = sb.id;
update adj_factor af inner join trade_cal tc on tc.cal_date = af.trade_date set af.date_id = tc.id;

update daily af inner join stock_basic sb on sb.ts_code = af.ts_code set af.code_id = sb.id;
update daily af inner join trade_cal tc on tc.cal_date = af.trade_date set af.date_id = tc.id;

update daily_basic af inner join stock_basic sb on sb.ts_code = af.ts_code set af.code_id = sb.id;
update daily_basic af inner join trade_cal tc on tc.cal_date = af.trade_date set af.date_id = tc.id;

#第三步：修改字段非空\

alter table adj_factor modify `date_id` int not null after id;
alter table adj_factor modify `code_id` int not null after date_id;

alter table daily modify `date_id` int not null after id;
alter table daily modify `code_id` int not null after date_id;

alter table daily_basic modify `date_id` int not null after id;
alter table daily_basic modify `code_id` int not null after date_id;

# 第四步：添加索引

ALTER TABLE adj_factor ADD index(`code_id`);
ALTER TABLE adj_factor ADD CONSTRAINT symbol UNIQUE KEY `unique_code_date`(`date_id`, `code_id`);

ALTER TABLE daily ADD index(`code_id`);
ALTER TABLE daily ADD CONSTRAINT symbol UNIQUE KEY `unique_code_date`(`date_id`, `code_id`);

ALTER TABLE daily_basic ADD index(`code_id`);
ALTER TABLE daily_basic ADD CONSTRAINT symbol UNIQUE KEY `unique_code_date`(`date_id`, `code_id`);

# 第五步：删除冗余索引

ALTER TABLE adj_factor DROP KEY code_date_unique_idx;

ALTER TABLE daily DROP KEY code_date_unique_idx;

ALTER TABLE daily_basic DROP KEY code_date_unique_idx;

# 第五步： 删除冗余字段

ALTER TABLE adj_factor DROP `ts_code`;
ALTER TABLE adj_factor DROP `trade_date`;
